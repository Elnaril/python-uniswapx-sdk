import time

from eth_account.messages import SignableMessage
from eth_utils import (
    to_bytes,
    to_hex,
)
import pytest
from web3.types import HexBytes

from tests.conftest import order_4
from uniswapx_sdk.encoder import (
    DecayTime,
    ExclusiveDutchOrderEncoder,
    ExclusiveDutchOrderInfo,
    ExclusiveDutchOrderInput,
    ExclusiveDutchOrderOutput,
    ExclusiveFiller,
    get_deadline,
    get_nonce,
)


# orderHash_1: 0xd1a982a611fc9dcd1230226140f22100994d769b2e01036dd8b3473ded7a3529
order_details_1 = \
    (
        (
            (
                '0x6000da47483062a0d734ba3dc7576ce6a0b645c4',
                '0xe7f525dd1bc6d748ae4d7f21d31e54741e05e110',
                1993350810584104428432150966441163937812467703763408189373898424638421800960,
                1704283964,
                '0x0000000000000000000000000000000000000000',
                b''
            ),
            1704283832,
            1704283952,
            '0x919f9173e2dc833ec708812b4f1cb11b1a17efde',
            100,
            ('0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', 11514000000, 11514000000),
            (
                (
                    '0x0000000000000000000000000000000000000000',
                    5357273070919632430,
                    5129553448285053856,
                    '0xe7f525dd1bc6d748ae4d7f21d31e54741e05e110'
                ),
                (
                    '0x0000000000000000000000000000000000000000',
                    8047981578747570,
                    7705889005936485,
                    '0x37a8f295612602f2774d331e562be9e61b83a327'
                )
            )
        ),
    )

order_info_1 = ExclusiveDutchOrderInfo(*order_details_1[0][0])
decay_time_1 = DecayTime(order_details_1[0][1], order_details_1[0][2])
dutch_input_1 = ExclusiveDutchOrderInput(*order_details_1[0][5])
dutch_outputs_1 = (ExclusiveDutchOrderOutput(*order_details_1[0][6][0]), ExclusiveDutchOrderOutput(*order_details_1[0][6][1]))  # noqa
exclusive_filler_1 = ExclusiveFiller(to_hex(hexstr=order_details_1[0][3]), order_details_1[0][4])

order_1 = (
    order_info_1,
    decay_time_1,
    dutch_input_1,
    dutch_outputs_1,
    exclusive_filler_1,
)

expected_args_1 = (('0x6000da47483062A0D734Ba3dc7576Ce6A0B645C4', '0xe7f525dd1bc6d748AE4D7F21D31e54741e05e110', 1993350810584104428432150966441163937812467703763408189373898424638421800960, 1704283964, '0x0000000000000000000000000000000000000000', b''), 1704283832, 1704283952, '0x919f9173E2Dc833Ec708812B4f1CB11B1a17eFDe', 100, ('0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', 11514000000, 11514000000), (('0x0000000000000000000000000000000000000000', 5357273070919632430, 5129553448285053856, '0xe7f525dd1bc6d748AE4D7F21D31e54741e05e110'), ('0x0000000000000000000000000000000000000000', 8047981578747570, 7705889005936485, '0x37a8f295612602f2774d331e562be9e61B83a327')))  # noqa
expected_encoded_order_1 = "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000065954eb80000000000000000000000000000000000000000000000000000000065954f30000000000000000000000000919f9173e2dc833ec708812b4f1cb11b1a17efde0000000000000000000000000000000000000000000000000000000000000064000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000002ae49b28000000000000000000000000000000000000000000000000000000002ae49b28000000000000000000000000000000000000000000000000000000000000002000000000000000000000000006000da47483062a0d734ba3dc7576ce6a0b645c4000000000000000000000000e7f525dd1bc6d748ae4d7f21d31e54741e05e11004683252def7714463ae315bbade448e191b5b652150ab5c0bfc7e4ee76b18000000000000000000000000000000000000000000000000000000000065954f3c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004a58db7954ee462e000000000000000000000000000000000000000000000000472fd5af056923a0000000000000000000000000e7f525dd1bc6d748ae4d7f21d31e54741e05e1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c9798bb28feb2000000000000000000000000000000000000000000000000001b607718e09f6500000000000000000000000037a8f295612602f2774d331e562be9e61b83a327"  # noqa
expected_signable_message_1 = SignableMessage(version=HexBytes('0x01'), header=b'\x86jZ\xba!\x96j\xf9]lz\xb7\x8e\xb2\xb2\xfc\x919\x15\xc2\x8b\xe3\xb9\xaa\x07\xcc\x04\xff\x90>?(', body=b'$t\xb9B\xc0\x85E\x1c/\xfd\x98\x0e\xe3r\x8d\\\x1f\xbf\x1e\x9c\xe4\xed\x14\x95\xbfn\xbc\x01:\xf51^')  # noqa


@pytest.mark.parametrize(
    "order, expected_args, expected_encoded_order, expected_signable_message",
    (
        (order_1, expected_args_1, expected_encoded_order_1, expected_signable_message_1),

    )
)
def test_exclusive_dutch_order_encoder(order, expected_args, expected_encoded_order, expected_signable_message):
    encoder = ExclusiveDutchOrderEncoder(1)
    assert expected_args == encoder._create_args(*order_1)
    encoded_order, signable_message = encoder.encode_order(*order_1)
    assert expected_encoded_order == to_hex(encoded_order)
    assert expected_signable_message == signable_message


def test_get_nonce():
    lower_bound = time.time_ns() * 10**58
    nonce = get_nonce()
    upper_bound = time.time_ns() * 10**58
    assert lower_bound < nonce < upper_bound


def test_get_deadline():
    start = int(time.time()) - 1
    duration = 100
    deadline = get_deadline(duration)
    stop = int(time.time()) + 1
    assert start + duration < deadline < stop + duration


expected_message_data_1 = \
    {
        'info': {
            'reactor': '0x6000da47483062A0D734Ba3dc7576Ce6A0B645C4',
            'swapper': '0xe7f525dd1bc6d748AE4D7F21D31e54741e05e110',
            'nonce': 1993350810584104428432150966441163937812467703763408189373898424638421800960,
            'deadline': 1704283964,
            'additionalValidationContract': '0x0000000000000000000000000000000000000000',
            'additionalValidationData': b''
        },
        'decayStartTime': 1704283832,
        'decayEndTime': 1704283952,
        'exclusiveFiller': '0x919f9173E2Dc833Ec708812B4f1CB11B1a17eFDe',
        'exclusivityOverrideBps': 100,
        'inputToken': '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
        'inputStartAmount': 11514000000,
        'inputEndAmount': 11514000000,
        'outputs': [
            {
                'token': '0x0000000000000000000000000000000000000000',
                'recipient': '0xe7f525dd1bc6d748AE4D7F21D31e54741e05e110',
                'startAmount': 5357273070919632430,
                'endAmount': 5129553448285053856
            },
            {
                'token': '0x0000000000000000000000000000000000000000',
                'recipient': '0x37a8f295612602f2774d331e562be9e61B83a327',
                'startAmount': 8047981578747570,
                'endAmount': 7705889005936485
            }
        ]
    }


def test_create_message_data():
    message_data = ExclusiveDutchOrderEncoder._create_message_data(*order_1)
    assert expected_message_data_1 == message_data


expected_signature_4 = "0xf4ff6b7dffc473ab3ad0d8635d1ce8fda152e3ef1786d66683edc84d49b5d0d072336c06dd04e17abd978a8737b78fbd7699694012c2378e8ffacad9b3ddde011c"  # noqa


def test_create_permit2_signable_message(account):
    encoder = ExclusiveDutchOrderEncoder(1)
    signable_message = encoder._create_signable_message(*order_4)
    signed_message = account.sign_message(signable_message)
    assert expected_signature_4 == signed_message.signature.hex()


execute_order = to_bytes(hexstr="0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000659a846e00000000000000000000000000000000000000000000000000000000659a84aa000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec60000000000000000000000000000000000000000000000000000000000000064000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000000000b76486a100000000000000000000000000000000000000000000000000000000b76486a100000000000000000000000000000000000000000000000000000000000002000000000000000000000000006000da47483062a0d734ba3dc7576ce6a0b645c400000000000000000000000015add8ad657fdbf4f2b3874266bd889572aeb26b0468323df93812c2f8020a347ce1df41c65593b4af69beeae8f9e24af555000000000000000000000000000000000000000000000000000000000000659a84b6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000b6c7076000000000000000000000000000000000000000000000000000000000b4bf444100000000000000000000000015add8ad657fdbf4f2b3874266bd889572aeb26b")  # noqa
execute_sig = to_bytes(hexstr="0xde3f54e8953b0114d393775233527a5ff7000f4e028421d5220557763a689563485112abe26128b8ed4c3379fcf80d5dea04a2b9f093b21fac63c84c1a5279c31b")  # noqa
expected_encoded_execute = "0x3f62192e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000659a846e00000000000000000000000000000000000000000000000000000000659a84aa000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec60000000000000000000000000000000000000000000000000000000000000064000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000000000b76486a100000000000000000000000000000000000000000000000000000000b76486a100000000000000000000000000000000000000000000000000000000000002000000000000000000000000006000da47483062a0d734ba3dc7576ce6a0b645c400000000000000000000000015add8ad657fdbf4f2b3874266bd889572aeb26b0468323df93812c2f8020a347ce1df41c65593b4af69beeae8f9e24af555000000000000000000000000000000000000000000000000000000000000659a84b6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000b6c7076000000000000000000000000000000000000000000000000000000000b4bf444100000000000000000000000015add8ad657fdbf4f2b3874266bd889572aeb26b0000000000000000000000000000000000000000000000000000000000000041de3f54e8953b0114d393775233527a5ff7000f4e028421d5220557763a689563485112abe26128b8ed4c3379fcf80d5dea04a2b9f093b21fac63c84c1a5279c31b00000000000000000000000000000000000000000000000000000000000000"  # noqa


def test_encode_execute():
    encoded_execute = ExclusiveDutchOrderEncoder.encode_execute(execute_order, execute_sig)
    assert isinstance(encoded_execute, str)
    assert expected_encoded_execute == encoded_execute
