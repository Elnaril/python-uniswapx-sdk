from aiohttp import ClientSession
import pytest

from uniswapx_sdk.api import UniswapXAPI


# https://api.uniswap.org/v2/orders?limit=10&sortKey=createdAt&desc=true&chainId=1
# https://api.uniswap.org/v2/uniswapx/docs


order_1 = {
    'outputs': [
        {
            'recipient': '0xa7152fad7467857dc2d4060fecaadf9f6b8227d3',
            'startAmount': '21269682010692619230',
            'endAmount': '21163333600639156133',
            'token': '0xC18360217D8F7Ab5e7c516566761Ea12Ce7F9D72'
        }
    ],
    'encodedOrder': '0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000006470c86f000000000000000000000000000000000000000000000000000000006470c8ab000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007d1afa7b718fb893db30a3abc0cfc608aacfebb000000000000000000000000000000000000000000000000dcf78d17097ebce3a00000000000000000000000000000000000000000000000dcf78d17097ebce3a0000000000000000000000000000000000000000000000000000000000000200000000000000000000000000bd7f9d0239f81c94b728d827a87b9864972661ec000000000000000000000000a7152fad7467857dc2d4060fecaadf9f6b8227d304683225a667f499301def22812b8a36285da4d28127da7e7edd841b6badf901000000000000000000000000000000000000000000000000000000006470c8ab000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c18360217d8f7ab5e7c516566761ea12ce7f9d72000000000000000000000000000000000000000000000001272d1718dcd98bde00000000000000000000000000000000000000000000000125b343c8192f7fa5000000000000000000000000a7152fad7467857dc2d4060fecaadf9f6b8227d3',  # noqa
    'signature': '0xc5b9ce377631bf5360f300b0902941a0689439660dea9c38f151bfb0ddb01fa33c7a39a86296dac844c97a1967490479810d92965594a7772360547b955c6c491c',  # noqa
    'input': {
        'endAmount': '254757602202795888186',
        'token': '0x7D1AfA7B718fb893dB30A3aBc0Cfc608AaCfeBB0',
        'startAmount': '254757602202795888186'
    },
    'settledAmounts': [
        {
            'tokenOut': '0xC18360217D8F7Ab5e7c516566761Ea12Ce7F9D72',
            'amountOut': '21241322434678362405'
        }
    ],
    'orderStatus': 'filled',
    'txHash': '0xf59162ba69c352248345e928587348a061059728d834dde3f9958f08a184752f',
    'createdAt': 1685112945,
    'chainId': 1,
    'orderHash': '0x84e53db3a3a213c5a7ea363339488f16d52fb19e407c275dc3d23ec59708f443',
    'type': 'DutchLimit'
}


@pytest.mark.asyncio(scope="session")
@pytest.mark.parametrize(
    "order_status, limit, order_hash, expected_order_count, expected_orders",
    (
        ("filled", 12, None, 12, None),
        ("filled", 10, "0x84e53db3a3a213c5a7ea363339488f16d52fb19e407c275dc3d23ec59708f443", 1, [order_1, ]),
    )
)
async def test_get_orders(order_status, limit, order_hash, expected_order_count, expected_orders):
    api = UniswapXAPI(1)
    kwargs = {"orderHash": order_hash} if order_hash else {}
    api_result = await api.get_orders(order_status=order_status, limit=limit, **kwargs)
    assert len(api_result["orders"]) == expected_order_count
    if expected_orders:
        for o in expected_orders:
            assert o in api_result["orders"]

    async with ClientSession() as client_session:
        api_result_with_seesion = await api.get_orders(order_status=order_status, limit=limit, session=client_session, **kwargs)  # noqa
        assert api_result_with_seesion == api_result
